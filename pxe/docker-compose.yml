services:
  dnsmasq:
    image: alpine:3
    command: ["sh", "-c", "apk add --no-cache dnsmasq && dnsmasq -d -C /etc/dnsmasq.conf"]
    network_mode: host
    cap_add:
      - NET_ADMIN
    volumes:
      - ./dnsmasq.conf:/etc/dnsmasq.conf:ro
      - tftp-data:/var/lib/tftpboot:ro
    depends_on:
      ipxe-copy:
        condition: service_completed_successfully
    restart: unless-stopped

  nginx:
    image: nginx:alpine
    ports:
      - "8888:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./boot.ipxe:/usr/share/nginx/html/boot.ipxe:ro
      - ./assets:/usr/share/nginx/html/assets:ro
      - ./config:/usr/share/nginx/html/config:ro
    restart: unless-stopped

  ipxe-copy:
    image: alpine:3
    command: ["cp", "/src/snponly.efi", "/tftpboot/snponly.efi"]
    volumes:
      - ./snponly.efi:/src/snponly.efi:ro
      - tftp-data:/tftpboot

volumes:
  tftp-data:
